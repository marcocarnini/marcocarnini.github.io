<!DOCTYPE html>
<html><head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    
    
    <title>The Data Science Explorer | Training a First Model</title>
    
</head>
<body><div id="nav-border" class="container">
    <nav id="nav" class="nav justify-content-center">
        
        <a class="nav-link" href="marcocarnini.com/">
        
        
        Home
        </a>
        
        <a class="nav-link" href="marcocarnini.com/about/">
        
        
        About
        </a>
        
        <a class="nav-link" href="marcocarnini.com/series/">
        
        
        Series
        </a>
        
        <a class="nav-link" href="marcocarnini.com/tags/">
        
        
        Tags
        </a>
        
        <a class="nav-link" href="marcocarnini.com/categories/">
        
        
        Categories
        </a>
        
        <a class="nav-link" href="marcocarnini.com/contact/">
        
        
        Contact
        </a>
        
    </nav>
</div>
<div id="content">
<h1>Training a First Model</h1>


<time datetime="2023-10-19">Oct 19, 2023</time>



<a class="myposts" href="marcocarnini.com/tags/python">Python</a>


<a class="myposts" href="marcocarnini.com/tags/machine-learning">Machine Learning</a>


<a class="myposts" href="marcocarnini.com/tags/classification">Classification</a>


<a class="myposts" href="marcocarnini.com/tags/kaggle">Kaggle</a>


<a class="myposts" href="marcocarnini.com/tags/random-forest">Random Forest</a>



<br><br>
<p>In this article, I build the first model. As a first step, I generate a simple model ignoring any possible complication: I discard any columns containing missing values and all the categorical columns.</p>
<p>I do not try to build new features nor to select the most relevant ones. Later, I will iteratively explore new features, impute missing data and encode the categorical variables.</p>
<h2 id="reading-the-data">Reading the data</h2>
<p>As a first step, I read the data:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> display
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> Markdown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../input/train.csv&#34;</span>)
</span></span><span style="display:flex;"><span>print(df<span style="color:#f92672">.</span>shape)
</span></span></code></pre></div><pre><code>(26570, 26)
</code></pre>
<p>Then, I check the types of all the columns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>temp1 <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>dtypes<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>temp1<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Type&#34;</span>]
</span></span><span style="display:flex;"><span>display(Markdown(temp1<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">Column</th>
<th style="text-align:left">Type</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">product_code</td>
<td style="text-align:left">object</td>
</tr>
<tr>
<td style="text-align:left">loading</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">attribute_0</td>
<td style="text-align:left">object</td>
</tr>
<tr>
<td style="text-align:left">attribute_1</td>
<td style="text-align:left">object</td>
</tr>
<tr>
<td style="text-align:left">attribute_2</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">attribute_3</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">measurement_0</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">measurement_1</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">measurement_2</td>
<td style="text-align:left">int64</td>
</tr>
<tr>
<td style="text-align:left">measurement_3</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_4</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_5</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_6</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_7</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_8</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_9</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_10</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_11</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_12</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_13</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_14</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_15</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_16</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">measurement_17</td>
<td style="text-align:left">float64</td>
</tr>
<tr>
<td style="text-align:left">failure</td>
<td style="text-align:left">int64</td>
</tr>
</tbody>
</table>
<p>Then, I estimate the frequency of missing values for each column:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>temp2 <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>temp2<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Missing frequency&#34;</span>]
</span></span><span style="display:flex;"><span>display(Markdown(temp2<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">Column</th>
<th style="text-align:right">Missing frequency</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">product_code</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">loading</td>
<td style="text-align:right">0.00940911</td>
</tr>
<tr>
<td style="text-align:left">attribute_0</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_1</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_2</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_3</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_0</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_1</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_2</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_3</td>
<td style="text-align:right">0.0143395</td>
</tr>
<tr>
<td style="text-align:left">measurement_4</td>
<td style="text-align:right">0.0202484</td>
</tr>
<tr>
<td style="text-align:left">measurement_5</td>
<td style="text-align:right">0.0254422</td>
</tr>
<tr>
<td style="text-align:left">measurement_6</td>
<td style="text-align:right">0.0299586</td>
</tr>
<tr>
<td style="text-align:left">measurement_7</td>
<td style="text-align:right">0.0352653</td>
</tr>
<tr>
<td style="text-align:left">measurement_8</td>
<td style="text-align:right">0.039443</td>
</tr>
<tr>
<td style="text-align:left">measurement_9</td>
<td style="text-align:right">0.0461799</td>
</tr>
<tr>
<td style="text-align:left">measurement_10</td>
<td style="text-align:right">0.0489274</td>
</tr>
<tr>
<td style="text-align:left">measurement_11</td>
<td style="text-align:right">0.0552503</td>
</tr>
<tr>
<td style="text-align:left">measurement_12</td>
<td style="text-align:right">0.0602559</td>
</tr>
<tr>
<td style="text-align:left">measurement_13</td>
<td style="text-align:right">0.066767</td>
</tr>
<tr>
<td style="text-align:left">measurement_14</td>
<td style="text-align:right">0.0705307</td>
</tr>
<tr>
<td style="text-align:left">measurement_15</td>
<td style="text-align:right">0.0756116</td>
</tr>
<tr>
<td style="text-align:left">measurement_16</td>
<td style="text-align:right">0.0794129</td>
</tr>
<tr>
<td style="text-align:left">measurement_17</td>
<td style="text-align:right">0.0859616</td>
</tr>
<tr>
<td style="text-align:left">failure</td>
<td style="text-align:right">0</td>
</tr>
</tbody>
</table>
<p>I summarize the results of the data exploration in a single table:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metadata <span style="color:#f92672">=</span> temp1<span style="color:#f92672">.</span>merge(temp2)
</span></span><span style="display:flex;"><span>display(Markdown(metadata<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:left">Column</th>
<th style="text-align:left">Type</th>
<th style="text-align:right">Missing frequency</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">id</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">product_code</td>
<td style="text-align:left">object</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">loading</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.00940911</td>
</tr>
<tr>
<td style="text-align:left">attribute_0</td>
<td style="text-align:left">object</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_1</td>
<td style="text-align:left">object</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_2</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">attribute_3</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_0</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_1</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_2</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
<tr>
<td style="text-align:left">measurement_3</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0143395</td>
</tr>
<tr>
<td style="text-align:left">measurement_4</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0202484</td>
</tr>
<tr>
<td style="text-align:left">measurement_5</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0254422</td>
</tr>
<tr>
<td style="text-align:left">measurement_6</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0299586</td>
</tr>
<tr>
<td style="text-align:left">measurement_7</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0352653</td>
</tr>
<tr>
<td style="text-align:left">measurement_8</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.039443</td>
</tr>
<tr>
<td style="text-align:left">measurement_9</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0461799</td>
</tr>
<tr>
<td style="text-align:left">measurement_10</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0489274</td>
</tr>
<tr>
<td style="text-align:left">measurement_11</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0552503</td>
</tr>
<tr>
<td style="text-align:left">measurement_12</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0602559</td>
</tr>
<tr>
<td style="text-align:left">measurement_13</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.066767</td>
</tr>
<tr>
<td style="text-align:left">measurement_14</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0705307</td>
</tr>
<tr>
<td style="text-align:left">measurement_15</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0756116</td>
</tr>
<tr>
<td style="text-align:left">measurement_16</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0794129</td>
</tr>
<tr>
<td style="text-align:left">measurement_17</td>
<td style="text-align:left">float64</td>
<td style="text-align:right">0.0859616</td>
</tr>
<tr>
<td style="text-align:left">failure</td>
<td style="text-align:left">int64</td>
<td style="text-align:right">0</td>
</tr>
</tbody>
</table>
<h2 id="the-pipeline">The pipeline</h2>
<p>I start with some mock functions for the full pipeline from data to the submission:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_validation</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">feature_engineering</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_model</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_model</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_performance</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_submission</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    read_data()
</span></span><span style="display:flex;"><span>    split_validation()
</span></span><span style="display:flex;"><span>    feature_engineering()
</span></span><span style="display:flex;"><span>    train_model()
</span></span><span style="display:flex;"><span>    validate_model()
</span></span><span style="display:flex;"><span>    create_submission()
</span></span><span style="display:flex;"><span>    store_performance()
</span></span></code></pre></div><p>I start by creating the <code>read_data</code> function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>() <span style="color:#f92672">-&gt;</span> tuple:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../input/train.csv&#34;</span>), pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../input/test.csv&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train, test <span style="color:#f92672">=</span> read_data()
</span></span></code></pre></div><p>For the validation, I split the training set into 10 folds by creating a temporary variable <code>fold</code> with random integers between 0 and 9:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>nfolds <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">2023</span>)
</span></span><span style="display:flex;"><span>df[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, nfolds, train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>set(df[<span style="color:#e6db74">&#34;fold&#34;</span>])
</span></span></code></pre></div><pre><code>{0, 1, 2, 3, 4, 5, 6, 7, 8, 9}
</code></pre>
<p>I refactored into a function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_validation</span>(N: int, nfolds: int) <span style="color:#f92672">-&gt;</span> pd<span style="color:#f92672">.</span>Series:
</span></span><span style="display:flex;"><span>    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">2023</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, nfolds, N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>nfolds <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">=</span> split_validation(train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], nfolds)
</span></span></code></pre></div><p>For the first model, I only consider for simplicity columns without missing data and of numeric type. From the dataframe <code>metadata</code>, I only select the columns that have no missing data and that are numerical:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metadata[(metadata[<span style="color:#e6db74">&#34;Type&#34;</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;object&#34;</span>) <span style="color:#f92672">&amp;</span> (metadata[<span style="color:#e6db74">&#34;Missing frequency&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)]
</span></span></code></pre></div><!-- raw HTML omitted -->
<pre><code>.dataframe tbody tr th {
    vertical-align: top;
}

.dataframe thead th {
    text-align: right;
}
</code></pre>
<p><!-- raw HTML omitted --></p>
<!-- raw HTML omitted -->
<p>I want the list of columns that satisfy the condition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>metadata<span style="color:#f92672">.</span>loc[
</span></span><span style="display:flex;"><span>    (metadata[<span style="color:#e6db74">&#34;Type&#34;</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;object&#34;</span>) <span style="color:#f92672">&amp;</span> (metadata[<span style="color:#e6db74">&#34;Missing frequency&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>), <span style="color:#e6db74">&#34;Column&#34;</span>
</span></span><span style="display:flex;"><span>]<span style="color:#f92672">.</span>to_list()
</span></span></code></pre></div><pre><code>['id',
 'attribute_2',
 'attribute_3',
 'measurement_0',
 'measurement_1',
 'measurement_2',
 'failure']
</code></pre>
<p>I then refactor into a single function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">feature_engineering</span>(train: pd<span style="color:#f92672">.</span>DataFrame, test: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> tuple:
</span></span><span style="display:flex;"><span>    temp1 <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>dtypes<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>    temp1<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Type&#34;</span>]
</span></span><span style="display:flex;"><span>    temp2 <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>    temp2<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Missing frequency&#34;</span>]
</span></span><span style="display:flex;"><span>    metadata <span style="color:#f92672">=</span> temp1<span style="color:#f92672">.</span>merge(temp2)
</span></span><span style="display:flex;"><span>    excluded <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>, <span style="color:#e6db74">&#34;fold&#34;</span>]
</span></span><span style="display:flex;"><span>    columns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        i
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> metadata<span style="color:#f92672">.</span>loc[
</span></span><span style="display:flex;"><span>            (metadata[<span style="color:#e6db74">&#34;Type&#34;</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;object&#34;</span>) <span style="color:#f92672">&amp;</span> (metadata[<span style="color:#e6db74">&#34;Missing frequency&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Column&#34;</span>,
</span></span><span style="display:flex;"><span>        ]<span style="color:#f92672">.</span>to_list()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> excluded
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> train[[<span style="color:#e6db74">&#34;fold&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>] <span style="color:#f92672">+</span> columns]<span style="color:#f92672">.</span>copy(), test[columns <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#34;id&#34;</span>]]<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>train, test <span style="color:#f92672">=</span> feature_engineering(train, test)
</span></span></code></pre></div><p>I validate that the folds are balanced in therms of failure rate:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>temp <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>groupby(<span style="color:#e6db74">&#34;fold&#34;</span>)[<span style="color:#e6db74">&#34;failure&#34;</span>]<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>temp<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Fold&#34;</span>, <span style="color:#e6db74">&#34;Failure rate&#34;</span>]
</span></span><span style="display:flex;"><span>display(Markdown(temp<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#34;Fold&#34;</span>)<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:right">Fold</th>
<th style="text-align:right">Failure rate</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0</td>
<td style="text-align:right">0.218013</td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td style="text-align:right">0.2213</td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td style="text-align:right">0.210666</td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td style="text-align:right">0.218095</td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td style="text-align:right">0.218257</td>
</tr>
<tr>
<td style="text-align:right">5</td>
<td style="text-align:right">0.197368</td>
</tr>
<tr>
<td style="text-align:right">6</td>
<td style="text-align:right">0.199697</td>
</tr>
<tr>
<td style="text-align:right">7</td>
<td style="text-align:right">0.211315</td>
</tr>
<tr>
<td style="text-align:right">8</td>
<td style="text-align:right">0.209546</td>
</tr>
<tr>
<td style="text-align:right">9</td>
<td style="text-align:right">0.221339</td>
</tr>
</tbody>
</table>
<p>and in terms of number of observations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>temp <span style="color:#f92672">=</span> train[<span style="color:#e6db74">&#34;fold&#34;</span>]<span style="color:#f92672">.</span>value_counts()<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>temp<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Fold&#34;</span>, <span style="color:#e6db74">&#34;Number of observations&#34;</span>]
</span></span><span style="display:flex;"><span>display(Markdown(temp<span style="color:#f92672">.</span>sort_values(<span style="color:#e6db74">&#34;Fold&#34;</span>)<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:right">Fold</th>
<th style="text-align:right">Number of observations</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0</td>
<td style="text-align:right">2587</td>
</tr>
<tr>
<td style="text-align:right">1</td>
<td style="text-align:right">2770</td>
</tr>
<tr>
<td style="text-align:right">2</td>
<td style="text-align:right">2644</td>
</tr>
<tr>
<td style="text-align:right">3</td>
<td style="text-align:right">2719</td>
</tr>
<tr>
<td style="text-align:right">4</td>
<td style="text-align:right">2662</td>
</tr>
<tr>
<td style="text-align:right">5</td>
<td style="text-align:right">2660</td>
</tr>
<tr>
<td style="text-align:right">6</td>
<td style="text-align:right">2639</td>
</tr>
<tr>
<td style="text-align:right">7</td>
<td style="text-align:right">2669</td>
</tr>
<tr>
<td style="text-align:right">8</td>
<td style="text-align:right">2577</td>
</tr>
<tr>
<td style="text-align:right">9</td>
<td style="text-align:right">2643</td>
</tr>
</tbody>
</table>
<p>I train the first model:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestClassifier
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Y <span style="color:#f92672">=</span> train[<span style="color:#e6db74">&#34;failure&#34;</span>]<span style="color:#f92672">.</span>to_list()
</span></span><span style="display:flex;"><span>X <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> RandomForestClassifier(random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">2023</span>)<span style="color:#f92672">.</span>fit(X, Y)
</span></span></code></pre></div><p>I refactor into a function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestClassifier
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_model</span>(df: pd<span style="color:#f92672">.</span>DataFrame):
</span></span><span style="display:flex;"><span>    Y <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;failure&#34;</span>]<span style="color:#f92672">.</span>to_list()
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> RandomForestClassifier(random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">2023</span>)<span style="color:#f92672">.</span>fit(X, Y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> train_model(train)
</span></span></code></pre></div><p>For validating the model, I train on all the data but those in the <code>fold</code> and calculate the metric (the area under the curve) on it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> roc_auc_score
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>fold <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>X_train <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">!=</span> fold]
</span></span><span style="display:flex;"><span>X_val <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">==</span> fold]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model <span style="color:#f92672">=</span> train_model(X_train)
</span></span><span style="display:flex;"><span>Y_predict <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(X_val<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>roc_auc_score(X_val[<span style="color:#e6db74">&#34;failure&#34;</span>], Y_predict)
</span></span></code></pre></div><pre><code>0.5039641638883339
</code></pre>
<p>I refactor into a function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> roc_auc_score
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_model</span>(fold: int, train: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>    X_train <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">!=</span> fold]
</span></span><span style="display:flex;"><span>    X_val <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">==</span> fold]
</span></span><span style="display:flex;"><span>    model <span style="color:#f92672">=</span> train_model(X_train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    Y_predict <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(X_val<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>, <span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> roc_auc_score(X_val[<span style="color:#e6db74">&#34;failure&#34;</span>], Y_predict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(nfolds):
</span></span><span style="display:flex;"><span>    print(validate_model(i, train))
</span></span></code></pre></div><pre><code>0.5015946929460144
0.5059618481048461
0.4970222605700502
0.492557415694866
0.4994574301875588
0.5118969555035129
0.5029505203841067
0.5000185306851299
0.501700485463372
0.5191908998031447
</code></pre>
<p>I estimate the average performance, and estimate the dispersion of the scores:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>scores <span style="color:#f92672">=</span> [validate_model(i, train) <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(nfolds)]
</span></span><span style="display:flex;"><span>print(np<span style="color:#f92672">.</span>mean(scores), <span style="color:#e6db74">&#34;+/-&#34;</span>, np<span style="color:#f92672">.</span>std(scores))
</span></span></code></pre></div><pre><code>0.5032351039342602 +/- 0.007206988478255747
</code></pre>
<p>Then, I create a dataframe associating the current model version with the performance on the folds:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>version <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.1</span>
</span></span><span style="display:flex;"><span>performance <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#34;Version&#34;</span>: [version] <span style="color:#f92672">*</span> nfolds, <span style="color:#e6db74">&#34;Scores&#34;</span>: scores})
</span></span><span style="display:flex;"><span>display(Markdown(performance<span style="color:#f92672">.</span>to_markdown(index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)))
</span></span><span style="display:flex;"><span>performance<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;performance_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><table>
<thead>
<tr>
<th style="text-align:right">Version</th>
<th style="text-align:right">Scores</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.501595</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.505962</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.497022</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.492557</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.499457</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.511897</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.502951</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.500019</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.5017</td>
</tr>
<tr>
<td style="text-align:right">0.1</td>
<td style="text-align:right">0.519191</td>
</tr>
</tbody>
</table>
<p>I refactor into a function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_performance</span>(version: float, scores: list) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    performance <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#34;Version&#34;</span>: [version] <span style="color:#f92672">*</span> nfolds, <span style="color:#e6db74">&#34;Scores&#34;</span>: scores})
</span></span><span style="display:flex;"><span>    performance<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;performance_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>store_performance(<span style="color:#ae81ff">0.1</span>, scores)
</span></span></code></pre></div><p>After storing the performance, I can retrain on all the <code>train</code>ing dataset:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>model <span style="color:#f92672">=</span> train_model(train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span></code></pre></div><p>I can score the <code>test</code> set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>test[<span style="color:#e6db74">&#34;failure&#34;</span>] <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(test<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;id&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>test<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;submission_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span></code></pre></div><p>I refactor into a function for creating the submission:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_submission</span>(model, test: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    test[<span style="color:#e6db74">&#34;failure&#34;</span>] <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(test<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;id&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    test[[<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>]]<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;submission_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>create_submission(model, test<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span></code></pre></div><h2 id="refactoring-into-a-single-function">Refactoring into a single function</h2>
<p>Finally, I refactor all the pipeline into a single script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> numpy <span style="color:#66d9ef">as</span> np
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pandas <span style="color:#66d9ef">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> roc_auc_score
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> sklearn.ensemble <span style="color:#f92672">import</span> RandomForestClassifier
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">read_data</span>() <span style="color:#f92672">-&gt;</span> tuple:
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../input/train.csv&#34;</span>), pd<span style="color:#f92672">.</span>read_csv(<span style="color:#e6db74">&#34;../input/test.csv&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">split_validation</span>(N: int, nfolds: int) <span style="color:#f92672">-&gt;</span> pd<span style="color:#f92672">.</span>Series:
</span></span><span style="display:flex;"><span>    np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>seed(<span style="color:#ae81ff">2023</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>random<span style="color:#f92672">.</span>randint(<span style="color:#ae81ff">0</span>, nfolds, N)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">feature_engineering</span>(train: pd<span style="color:#f92672">.</span>DataFrame, test: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> tuple:
</span></span><span style="display:flex;"><span>    temp1 <span style="color:#f92672">=</span> train<span style="color:#f92672">.</span>dtypes<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>    temp1<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Type&#34;</span>]
</span></span><span style="display:flex;"><span>    temp2 <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>isna()<span style="color:#f92672">.</span>mean()<span style="color:#f92672">.</span>reset_index()
</span></span><span style="display:flex;"><span>    temp2<span style="color:#f92672">.</span>columns <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;Column&#34;</span>, <span style="color:#e6db74">&#34;Missing frequency&#34;</span>]
</span></span><span style="display:flex;"><span>    metadata <span style="color:#f92672">=</span> temp1<span style="color:#f92672">.</span>merge(temp2)
</span></span><span style="display:flex;"><span>    excluded <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>, <span style="color:#e6db74">&#34;fold&#34;</span>]
</span></span><span style="display:flex;"><span>    columns <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span>        i
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> metadata<span style="color:#f92672">.</span>loc[
</span></span><span style="display:flex;"><span>            (metadata[<span style="color:#e6db74">&#34;Type&#34;</span>] <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;object&#34;</span>) <span style="color:#f92672">&amp;</span> (metadata[<span style="color:#e6db74">&#34;Missing frequency&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#e6db74">&#34;Column&#34;</span>,
</span></span><span style="display:flex;"><span>        ]<span style="color:#f92672">.</span>to_list()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> i <span style="color:#f92672">not</span> <span style="color:#f92672">in</span> excluded
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> train[[<span style="color:#e6db74">&#34;fold&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>] <span style="color:#f92672">+</span> columns]<span style="color:#f92672">.</span>copy(), test[columns <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#34;id&#34;</span>]]<span style="color:#f92672">.</span>copy()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train_model</span>(df: pd<span style="color:#f92672">.</span>DataFrame):
</span></span><span style="display:flex;"><span>    Y <span style="color:#f92672">=</span> df[<span style="color:#e6db74">&#34;failure&#34;</span>]<span style="color:#f92672">.</span>to_list()
</span></span><span style="display:flex;"><span>    X <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> RandomForestClassifier(random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">2023</span>)<span style="color:#f92672">.</span>fit(X, Y)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate_model</span>(fold: int, train: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> float:
</span></span><span style="display:flex;"><span>    X_train <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">!=</span> fold]
</span></span><span style="display:flex;"><span>    X_val <span style="color:#f92672">=</span> train[train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">==</span> fold]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    model <span style="color:#f92672">=</span> train_model(X_train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    Y_predict <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(X_val<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;failure&#34;</span>, <span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> roc_auc_score(X_val[<span style="color:#e6db74">&#34;failure&#34;</span>], Y_predict)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">store_performance</span>(version: float, scores: list) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    performance <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame({<span style="color:#e6db74">&#34;Version&#34;</span>: [version] <span style="color:#f92672">*</span> nfolds, <span style="color:#e6db74">&#34;Scores&#34;</span>: scores})
</span></span><span style="display:flex;"><span>    performance<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;performance_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_submission</span>(model, test: pd<span style="color:#f92672">.</span>DataFrame) <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">None</span>:
</span></span><span style="display:flex;"><span>    test[<span style="color:#e6db74">&#34;failure&#34;</span>] <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>predict(test<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;id&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    test[[<span style="color:#e6db74">&#34;id&#34;</span>, <span style="color:#e6db74">&#34;failure&#34;</span>]]<span style="color:#f92672">.</span>to_csv(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#34;submission_</span><span style="color:#e6db74">{</span>version<span style="color:#e6db74">}</span><span style="color:#e6db74">.csv&#34;</span>, index<span style="color:#f92672">=</span><span style="color:#66d9ef">False</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    nfolds <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>    train, test <span style="color:#f92672">=</span> read_data()
</span></span><span style="display:flex;"><span>    train[<span style="color:#e6db74">&#34;fold&#34;</span>] <span style="color:#f92672">=</span> split_validation(train<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], nfolds)
</span></span><span style="display:flex;"><span>    train, test <span style="color:#f92672">=</span> feature_engineering(train, test)
</span></span><span style="display:flex;"><span>    model <span style="color:#f92672">=</span> train_model(train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#34;fold&#34;</span>], axis<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>))
</span></span><span style="display:flex;"><span>    create_submission(model, test)
</span></span></code></pre></div><p>In the next article, I want to improve the Feature Engineering part of the pipeline while maintaining the rest (like the data reading, submission preparation and performance storing).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"></code></pre></div>

        </div><p class="footer text-center">&copy; 2023 Marco Carnini</p>
</body>
</html>
